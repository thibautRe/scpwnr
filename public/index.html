<!DOCTYPE html>
<html>
<head>
  <title>Soundcloud Pwnr*</title>
  <link rel="stylesheet" type="text/css" href="/styles/app.css">
  <link href='http://fonts.googleapis.com/css?family=Raleway:400,100,200,300,500,600,700' rel='stylesheet' type='text/css'>
</head>
<body>

<h1>Sc Pwnr*</h1>
<h2>Soundcloud's home-made, powerful, and fresh Pwnr.</h2>

<form class="form--main js-form--main" action="/song">
  <input class="form-square form-url" name="url" data-bind="value: trackUrl"/>
  <button class="form-square form-submit" type="submit">Convertir</button>
</form>

<!-- ko foreach: conversions -->
  <div class="conversion" data-bind="style: $root.getStyleFromStatus(status)">
    <button class="conversion-delete" data-bind="click: function() {$root.deleteConversion($data)}">&times;</button>
    <!-- ko ifnot: isExpanded -->
      <button class="conversion-seemore" data-bind="click: expand">Voir plus </button>
    <!-- /ko -->

    <!-- ko if: isExpanded -->
      <div class="conversion-info">
        <h3 class="conversion-info-title">ID</h3>
        <span class="conversion-info-desc" data-bind="text: id"></span>
      </div>
      <div class="conversion-info">
        <h3 class="conversion-info-title">URL</h3>
        <a class="conversion-info-desc" data-bind="text: url, attr: {href: url}"></a>
      </div>
      <div class="conversion-info">
        <h3 class="conversion-info-title">Status</h3>
        <span class="conversion-info-desc" data-bind="text: status"></span>
      </div>

      <!-- ko if: status() == 'finish' -->
        <div class="conversion-info">
          <h3 class="conversion-info-title">Tracks</h3>
          <span class="conversion-info-desc" data-bind="text: tracks().length"></span>
        </div>

        <!-- ko foreach: tracks -->
          <a class="conversion-track" data-bind="attr: {href: url}">
            <img data-bind="attr: {src: coverUrl}" class="conversion-cover">
            <span class="track-name" data-bind="text: getName()"></span>
            <span class="track-progress" data-bind="css: {'track-progress--finish': downloadStatus()=='downloaded'}">
              <span class="track-progress-percent" data-bind="style: {width: downloadProgress() + '%'}"></span>
            </span>
          </a>
        <!-- /ko -->
      <!-- /ko -->

      <!-- ko if: status() == 'error' && errorMsg -->
      <div class="conversion-info">
        <h3 class="conversion-info-title">Error msg</h3>
        <span class="conversion-info-desc" data-bind="text: errorMsg"></span>
      </div>
      <!-- /ko -->
    <!-- /ko -->
  </div>
<!-- /ko -->


<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/zepto/1.1.4/zepto.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/knockout/3.2.0/knockout-min.js"></script>
<script type="text/javascript" src="/scripts/scpwnr-client.js"></script>
<script type="text/javascript" src="/scripts/conversion.js"></script>
<script type="text/javascript" src="/scripts/track.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  var io = io.connect();
  var conversions = ko.observableArray([]);
  var trackUrl = ko.observable('');

  var findConversionById = function(id) {
    var _conversions = conversions();
    for (var i in _conversions) {
      if (_conversions[i].id == id) {
        return _conversions[i];
      }
    }
  };

  // Listen for the talk event.
  io.on('conv-begin', function(data) {
    var newConversion = new Conversion(data.id);
    conversions.unshift(newConversion);
    newConversion.status('pending');
    newConversion.url(data.url);
  });
  io.on('conv-finish', function(data) {
    var conversion = findConversionById(data.id);
    conversion.status('finish');

    // Make Track objects
    var bufferTracks = [];
    for (var i in data.tracks) {
      var newTrack = new Track(data.tracks[i]);
      bufferTracks.push(newTrack);
    }
    conversion.tracks(bufferTracks);
  });
  io.on('conv-error', function(data) {
    var conversion = findConversionById(data.id);
    conversion.status('error');
    conversion.errorMsg(data.consoleMsg.stdout);
  });
  io.on('down-progress', function(data) {
    var conversion = findConversionById(data.id);
    var track = conversion.findTrackByName(data.name);
    track.downloadProgress(data.progress);
  });
  io.on('down-finish', function(data) {
    var conversion = findConversionById(data.id);
    var track = conversion.findTrackByName(data.name);
    track.downloadStatus('downloaded');
  });

  var requestForm = $('.js-form--main');

  // on submit
  requestForm.submit(function() {
    var url = getCleanedUrl(trackUrl());
    trackUrl('');

    if (url === undefined) {
      // message('URL unrecognized');
      return false;
    }

    // Disable the form
    $('js-form--main input').attr('disabled', 'true');

    io.emit('conv-request', {
      url: url,
      type: getUrlType(url)
    });

    return false;
  });

  ko.applyBindings({
    conversions: conversions,
    trackUrl: trackUrl,
    getStyleFromStatus: function(status) {
      if (status() == 'finish') {
        return {'background-color': 'rgba(20,240,20,.1)'}
      }
      else if (status() == 'error') {
        return {'background-color': 'rgba(240,20,20,.1)'}
      }
    },
    deleteConversion: function(conversion) {
      conversions.remove(conversion);
    }
  });

</script>
</body>